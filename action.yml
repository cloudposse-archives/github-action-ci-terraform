name: 'terraform-ci'
description: "Run CI for Terraform (with support for chatops)"
inputs:
  token:
    description: "github token"
    required: true
  OPSGENIE_API_KEY:
    required: true
runs:
  using: "composite"
  steps:
    - name: "Checkout commit"
      uses: actions/checkout@v2

    - name: "Extract Necessary Metadata"
      id: metadata
      uses: cloudposse/github-action-terraform-ci/actions/metadata@main

    - name: "Respond to chatops comment"
      #if: github.event.comment
      if: github.event.comment && contains(steps.metadata.outputs.valid-test-request, 'true')
      uses: cloudposse/github-action-terraform-ci/actions/comment-response@main
      with:
        comment_id: ${{ github.event.comment.id }}
        #tests_names: ${{ steps.metadata.outputs.tests-names }}
        recognized_tests: ${{ steps.metadata.outputs.recognized-tests }}
        unrecognized_tests: ${{ steps.metadata.outputs.unrecognized-tests }}

    - name: "Record pending status for all forthcoming checks"
      uses: cloudposse/github-action-terraform-ci/actions/bulk-status-update@main
      with:
        token: ${{ inputs.token }}
        #test-names: ${{ steps.metadata.outputs.tests-names }}
        test-names: ${{ steps.metadata.outputs.recognized-tests }}
        sha: ${{ steps.metadata.outputs.pr-sha }}
        status: 'pending'

    - name: "Run all requested tests"
      #if: contains(steps.metadata.outputs.tests-names, 'unrecognized') != true && contains(steps.metadata.outputs.tests-names, 'none') != true
      uses: cloudposse/github-action-terraform-ci/actions/run-tests@main
      with:
        token: ${{ inputs.token }}
        #tests-names: ${{ steps.metadata.outputs.tests-names }}
        tests-names: ${{ steps.metadata.outputs.recognized-tests }}
        pr-sha: ${{ steps.metadata.outputs.pr-sha }}
        base-ref: ${{ steps.metadata.outputs.pr-base-ref }}
        labels: ${{ steps.metadata.outputs.pr-labels }}
        OPSGENIE_API_KEY: ${{ inputs.OPSGENIE_API_KEY }}

    - name: "Record cancelled status for all pending and completed checks, if necessary"
      if: cancelled()
      uses: cloudposse/github-action-terraform-ci/actions/bulk-status-update@main
      with:
        token: ${{ inputs.token }}
        #test-names: ${{ steps.metadata.outputs.tests-names }}
        test-names: ${{ steps.metadata.outputs.recognized-tests }}
        sha: ${{ steps.metadata.outputs.pr-sha }}
        status: 'error'

#    - name: "Handle common commands"
#      uses: peter-evans/slash-command-dispatch@v2.3.0
#      #uses: cloudposse/actions/github/slash-command-dispatch@0.22.0
#      with:
#        token: ${{ inputs.token }}
#        reaction-token: ${{ inputs.reaction-token }}
#        repository: cloudposse/actions
#        commands: rebuild-readme, terraform-fmt
#        permission: triage
#        issue-type: pull-request
#    - name: "Run tests"
#      uses: peter-evans/slash-command-dispatch@v2.3.0
#      #uses: cloudposse/actions/github/slash-command-dispatch@0.22.0
#      with:
#        token: ${{ inputs.token }}
#        reaction-token: ${{ inputs.reaction-token }}
#        repository: cloudposse/actions
#        commands: test
#        permission: triage
#        issue-type: pull-request
#        reactions: false

name: 'terraform-ci'
description: 'Run chatops github actions'
inputs:
  token:
    description: "github token"
    required: true
  test-name:
    description: "name of the github action status check that will be calling this action as a step"
    required: true
  sha:
    description: "SHA hash of the commit whose status will be modified"
    required: true
runs:
  using: "composite"
  steps:
    - name: "Acknowledge '/test bats'"
      uses: actions/github-script@v4
      with:
        script: |
          const {owner, repo} = context.issue
          github.reactions.createForIssueComment({
            owner,
            repo,
            comment_id: context.payload.comment.id,
            content: "+1",
          });
    - name: "Record pending '/test bats' result"
      uses: Sibz/github-status-action@v1
      with:
        authToken: ${{ inputs.token }}
        context: ${{ inputs.test-name }}
        description: 'Computing...'
        state: 'pending'
        sha: ${{ inputs.sha }}
    - name: "Execute /test bats 1"
      uses: docker://cloudposse/test-harness:latest
      env:
        MAKE_INCLUDES: Makefile
        TF_PLUGIN_CACHE_DIR: /tmp
      with:
        entrypoint: make
        args: "-C test/ clean init"
    - name: "Execute /test bats 2"
      uses: docker://cloudposse/test-harness:latest
      env:
        MAKE_INCLUDES: Makefile
        TF_PLUGIN_CACHE_DIR: /tmp
      with:
        entrypoint: make
        args: "-C test/ module"
    - name: "Execute /test bats 3"
      uses: docker://cloudposse/test-harness:latest
      env:
        MAKE_INCLUDES: Makefile
        TF_PLUGIN_CACHE_DIR: /tmp
      with:
        entrypoint: make
        args: "-C test/ examples/complete"
    - name: "Record successful '/test bats' result"
      uses: Sibz/github-status-action@v1
      with:
        authToken: ${{ inputs.token }}
        context: ${{ inputs.test-name }}
        description: 'Passed'
        state: 'success'
        sha: ${{ inputs.sha }}
    - name: "Record unsuccessful '/test bats' result"
      if: failure()
      uses: Sibz/github-status-action@v1
      with:
        authToken: ${{ inputs.token }}
        context: ${{ inputs.test-name }}
        description: 'Failed'
        state: 'failure'
        sha: ${{ inputs.sha }}

name: "terraform-ci-command-rebuild-readme"
description: "Rebuild readme"
inputs:
  token:
    description: "github token"
    required: true
  command-name:
    description: "name of the github action status check that will be calling this action as a step"
    required: true
#  sha:
#    description: "SHA hash of the commit whose status will be modified"
#    required: true
runs:
  using: "composite"
  steps:
    # Export script to rebuild README and commit changes (if any) to the PR branch
    - name: Export rebuild README script
      shell: bash
      run: |
        cat << "EOF" > rebuild_readme.sh
        #!/bin/bash

        make init
        make readme/deps
        make readme

        set -x
        output=$(git diff --name-only)
        if [ -n "$output" ]; then
          echo "Changes detected. Pushing to the PR branch"
          git config --global user.name 'actions-bot'
          git config --global user.email '58130806+actions-bot@users.noreply.github.com'
          git add -A
          git commit -m "Updated README.md"
          git push
        else
          echo "No changes detected"
        fi
        EOF
        chmod a+x rebuild_readme.sh

    # Rebuild README and commit changes (if any) to the PR branch
    - name: "Rebuild README and commit changes (if any)"
      uses: docker://cloudposse/build-harness:slim-latest
      with:
        entrypoint: "/github/workspace/rebuild_readme.sh"

#    - name: "Record status"
#      if: always()
#      uses: cloudposse/github-action-terraform-ci/actions/status@main
#      with:
#        token: ${{ inputs.token }}
#        test-name: ${{ inputs.command-name }}
#        sha: ${{ inputs.sha }}
#        status: ${{ github.action_status }}
